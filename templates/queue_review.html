{% extends "layout.html" %}

{% block title %}Review Queue - Medicaid Audit Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list-check"></i> Review Queue</h2>
                <div>
                    <a href="{{ url_for('audit_search_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Back to Search
                    </a>
                </div>
            </div>

            {% if total_pending == 0 %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h4>No Reports Pending Review</h4>
                    <p>Use the audit search to find and add reports to the review queue.</p>
                    <a href="{{ url_for('audit_search_page') }}" class="btn btn-primary">
                        <i class="fas fa-search"></i> Start Search
                    </a>
                </div>
            {% else %}
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock"></i> 
                                    {{ total_pending }} Report{{ 's' if total_pending != 1 else '' }} Pending Review
                                </h5>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="selectAll()">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="selectNone()">
                                        <i class="fas fa-square"></i> Select None
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>AI Provider & Model Choice:</strong> Choose your AI provider and model for processing. 
                            GPT-5-nano offers 8x lower cost and better accuracy than GPT-4.1-nano.
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="aiProviderSelect" class="form-label">
                                    <i class="fas fa-robot"></i> AI Provider & Model
                                </label>
                                <select class="form-select" id="aiProviderSelect" onchange="updateCostEstimate()">
                                    <option value="openai_gpt5" selected data-cost="0.02">ðŸ†• OpenAI GPT-5-nano (Recommended)</option>
                                    <option value="openai_gpt41" data-cost="0.16">OpenAI GPT-4.1-nano (Legacy)</option>
                                    <option value="gemini" data-cost="0.03">Google Gemini 2.5-flash</option>
                                </select>
                                <small class="text-muted">
                                    <span id="costEstimate">~$0.02 per report</span> â€¢ <span id="modelDescription">Latest model with 45% fewer errors</span>
                                </small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-success" onclick="approveSelected()">
                                        <i class="fas fa-check"></i> Process Selected
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="skipSelected()">
                                        <i class="fas fa-times"></i> Skip Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">
                                <span id="selectedCount">0</span> reports selected for processing
                            </small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    {% for item in pending_items %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 queue-item" data-item-id="{{ item.id }}">
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input item-checkbox" type="checkbox" 
                                           id="item_{{ item.id }}" onchange="updateSelectedCount()">
                                    <label class="form-check-label fw-bold" for="item_{{ item.id }}">
                                        {{ item.title | truncate(80) }}
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">
                                        {% if item.source_domain == "manual_upload" %}
                                            <i class="fas fa-upload"></i> Manually Uploaded
                                        {% else %}
                                            <i class="fas fa-globe"></i> {{ item.source_domain }}
                                        {% endif %}
                                    </small>
                                </div>

                                {% if item.ai_classification %}
                                <div class="mb-2">
                                    {% if item.ai_classification.get('is_medicaid_audit') %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Medicaid Audit
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-question"></i> Not Medicaid Audit
                                        </span>
                                    {% endif %}
                                    
                                    {% if item.user_override %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-user"></i> User Override
                                        </span>
                                    {% endif %}
                                </div>

                                {% if item.ai_classification.get('reasoning') %}
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <strong>AI Reasoning:</strong> {{ item.ai_classification.reasoning | truncate(150) }}
                                    </small>
                                </div>
                                {% endif %}
                                {% endif %}

                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> Added {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                </div>

                                <div class="d-grid gap-2">
                                    {% if item.source_domain == "manual_upload" %}
                                        <button class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-file-pdf"></i> Uploaded File
                                        </button>
                                    {% else %}
                                        <a href="{{ item.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> View Original PDF
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card mt-4">
                    <div class="card-footer text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-lg" onclick="approveSelected()">
                                <i class="fas fa-check"></i> Process Selected Reports
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="skipSelected()">
                                <i class="fas fa-times"></i> Skip Selected
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let domReady = false;

function selectAll() {
    if (!domReady) return;
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function selectNone() {
    if (!domReady) return;
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    if (!domReady) return;
    const selected = document.querySelectorAll('.item-checkbox:checked').length;
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = selected;
    }
}

function getSelectedItemIds() {
    const selected = [];
    document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
        const itemId = checkbox.closest('.queue-item').dataset.itemId;
        selected.push(parseInt(itemId));
    });
    return selected;
}

function updateCostEstimate() {
    const select = document.getElementById('aiProviderSelect');
    const selectedOption = select.options[select.selectedIndex];
    const cost = selectedOption.getAttribute('data-cost');
    const costElement = document.getElementById('costEstimate');
    const descElement = document.getElementById('modelDescription');
    
    if (costElement) {
        costElement.textContent = `~$${cost} per report`;
    }
    
    if (descElement) {
        const value = selectedOption.value;
        if (value === 'openai_gpt5') {
            descElement.textContent = 'Latest model with 45% fewer errors';
        } else if (value === 'openai_gpt41') {
            descElement.textContent = 'Legacy model (8x more expensive)';
        } else {
            descElement.textContent = 'Google AI with native Pydantic support';
        }
    }
}

function approveSelected() {
    const selectedIds = getSelectedItemIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one report to process.');
        return;
    }
    
    const providerSelect = document.getElementById('aiProviderSelect').value;
    let aiProvider, aiModel, providerName;
    
    switch(providerSelect) {
        case 'openai_gpt5':
            aiProvider = 'openai';
            aiModel = 'gpt-5-nano';
            providerName = 'OpenAI GPT-5-nano';
            break;
        case 'openai_gpt41':
            aiProvider = 'openai';
            aiModel = 'gpt-4.1-nano';
            providerName = 'OpenAI GPT-4.1-nano';
            break;
        case 'gemini':
            aiProvider = 'gemini';
            aiModel = null;
            providerName = 'Google Gemini 2.5-flash';
            break;
        default:
            aiProvider = 'openai';
            aiModel = 'gpt-5-nano';
            providerName = 'OpenAI GPT-5-nano';
    }

    if (!confirm(`Process ${selectedIds.length} selected reports using ${providerName} for AI extraction?`)) {
        return;
    }

    const requestBody = {
        item_ids: selectedIds,
        ai_provider: aiProvider
    };
    
    if (aiModel) {
        requestBody.ai_model = aiModel;
    }

    fetch('/api/queue/approve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

function skipSelected() {
    const selectedIds = getSelectedItemIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one report to skip.');
        return;
    }

    if (!confirm(`Skip ${selectedIds.length} selected reports? They will not be processed.`)) {
        return;
    }

    fetch('/api/queue/skip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

// Initialize count on page load
document.addEventListener('DOMContentLoaded', function() {
    domReady = true;
    updateSelectedCount();
    updateCostEstimate(); // Initialize cost display
});
</script>
{% endblock %}